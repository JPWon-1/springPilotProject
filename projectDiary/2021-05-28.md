# 오늘의 기록
### 1) application.yml 을 새로 만들었다
- yml이 보기 더 깔끔하고, 관리에 좀 더 용이한 것 같아 앞으로 이 방식을 이용할 것이다.
### 2) securityConfig를 다시 해주었다.
- session id로 session 연결 관리를 하는 방식에서 jwt로 세션관리를 하는 방식으로 바꾸고 있다.
- 이 과정에서 WebSecurityConfig를 지우고 SecurityConfig를 새로 생성하였다.
### 3) security filter chain과 filterRegistrationBean이 어느 순서로 실행되는지 확인 해보았다.
- http.addFilter 를 통해 configure가 실행되면서 필터가 실행되는 것을 테스트해보았고
filterRegistrationBean을 통해 만든 필터들은 configure가 끝나고 나서야 실행이 되었다.
### 4) configure에서 formLogin을 disable 해놓았다.
- input 값을 던져 backend에서 확인하던 방법이 아닌 front에서 확인 하는 방법을 사용하기 떄문이다
### 5) 따라서 addFilter(new JwtAuthenticationFilter(authenticationManager())) 를 추가해주었다.
### 6) JwtAuthenticationFilter extends UserNamePasswordAuthenticationFilter 를 해준다
### 7) 이는 로그인 과정에서 자동으로 실행되는 함수이다.
UsernamePasswordAuthenticationFilter에 도달했을때 AbstractAuthenticationProcessingFilter클래스를 통해 로그인 URL인지 확인하고 로그인 요청이 확인 될 시 아이디 패스워드를 가져와서 인증을 위한 객체를 생성한다.
### 8) attemptAuthentication 을 overide한다.
- 이 곳에서 아이디와 패스워드를 받아 전달받은 아이디와 비밀번호가 정상인지 로그인 시도를 해서 판단을 한다.
- 과정에서 PrincipalDetailsService가 호출되고 loadUserByUsername이 실행된다.
- PrincipalDetails를 세션에 담고(권한관리를 위해서) JWT를 만들어 응답을 해주면 된다.
- JWT는 이곳에서 할 필요가 없다
### 9) JWT를 attemptAuthentication에서 할 필요가 없는 이유는
- attemptAuthentication에서 인증이 정상적으로 되었으면 succesfulAuthentication이 실행되는데
- 이 곳에서 JWT을 만들어서 request 요청한 사용자에게 JWT토큰을 response해주면 된다.
```
 // Hash암호 방식
    String jwtToken = JWT.create()//JWT라이브러리
            .withSubject("cos토큰")
            .withExpiresAt(new Date(System.currentTimeMillis()+(600000*10)))
            .withClaim("id", principalDetails.getUser().getEmail())
            .withClaim("username", principalDetails.getUser().getFirstName())
            .sign(Algorithm.HMAC512("cos"));
    response.addHeader("Authorization", "Bearer "+jwtToken);
```
를 했을 때 헤더 키 값중 Authorization에 Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJjb3PthqDtgbAiLCJpZCI6IjEyMzEyMyIsImV4cCI6MTYyMjIyNjc0Mn0.pX9BmuYoHOcJ7Uu2fKJ73EtaoUY3jozT4aUZjfw2_C6Eo8BwCXi6mgnIfHW1DwCjN1N-WGHAcKTi8dXHjolo1Q
가 담겨있는 것을 확인했다.

다음을 확인해보니 <img src="img/jwt.png"> 로 디코드 되는 것 까지 확인하였다.

